import asyncio
import json
import os
import sys
from datetime import datetime
import uuid

current_dir = os.path.dirname(os.path.abspath(__file__))
src_path = os.path.join(current_dir, 'src')
if src_path not in sys.path:
    sys.path.insert(0, src_path)

try:
    import structlog
    
    structlog.configure(
        processors=[
            structlog.stdlib.filter_by_level,
            structlog.stdlib.add_logger_name,
            structlog.stdlib.add_log_level,
            structlog.stdlib.PositionalArgumentsFormatter(),
            structlog.processors.TimeStamper(fmt="iso"),
            structlog.processors.JSONRenderer()
        ],
        context_class=dict,
        logger_factory=structlog.stdlib.LoggerFactory(),
        wrapper_class=structlog.stdlib.BoundLogger,
        cache_logger_on_first_use=True,
    )
    
    logger = structlog.get_logger(__name__)
except ImportError:
    print("Warning: structlog not available, using basic logging")
    import logging
    logging.basicConfig(level=logging.INFO)
    logger = logging.getLogger(__name__)

try:
    from utils.json_saver import JSONResponseSaver
    JSON_SAVING_AVAILABLE = True
except ImportError:
    print("Warning: JSON saver not available")
    JSON_SAVING_AVAILABLE = False

async def enhanced_database_cli_with_json():
    
    print("\n" + "="*80)
    print("ü§ñ ENHANCED AZURE OPENAI DATABASE ASSISTANT")
    print("‚ö° Powered by Azure OpenAI with JSON Output & Saving")
    print("üíæ All responses automatically saved as JSON files")
    print("üí¨ Ask me anything about your healthcare data!")
    print("="*80)
    
    json_saver = None
    if JSON_SAVING_AVAILABLE:
        json_saver = JSONResponseSaver("json_responses")
        print("‚úÖ JSON saving enabled - responses will be saved to 'json_responses/' folder")
    else:
        print("‚ö†Ô∏è  JSON saving not available - responses will only be displayed")
    
    session_id = f"session_{datetime.now().strftime('%Y%m%d_%H%M%S')}_{str(uuid.uuid4())[:8]}"
    print(f"üìã Session ID: {session_id}")
    
    session_responses = []
    
    schema_description = None
    try:
        with open("/home/afour/Desktop/SQL_Agent/generic_sql_agent/description.txt", 'r', encoding='utf-8') as f:
            schema_description = f.read().strip()
            print(f"‚úÖ Loaded database description ({len(schema_description)} characters)")
    except FileNotFoundError:
        print("‚ö†Ô∏è  description.txt not found - will infer from database structure")
    except Exception as e:
        print(f"‚ö†Ô∏è  Error loading description.txt: {e}")
    
    print("\nüîß Initializing database agent...")
    
    agent = None
    agent_type = "unknown"
    
    try:
        from agents.react_agent import AzureReActDatabaseAgent
        agent = AzureReActDatabaseAgent()
        agent_type = "ReAct Agent"
        print("‚úÖ ReAct Agent initialized successfully!")
    except Exception as e:
        print(f"‚ö†Ô∏è  ReAct Agent failed: {e}")
        
        try:
            from agents.db_agent import AzureIntelligentDatabaseAgent
            agent = AzureIntelligentDatabaseAgent()
            agent_type = "Enhanced Node Workflow"
            print("‚úÖ Enhanced Node Workflow initialized successfully!")
        except Exception as e:
            print(f"‚ö†Ô∏è  Enhanced Node Workflow failed: {e}")
            
            try:
                from agents.db_agent import EnhancedReActDatabaseAgent
                agent = EnhancedReActDatabaseAgent()
                agent_type = "Fallback Agent"
                print("‚úÖ Fallback Agent initialized successfully!")
            except Exception as e:
                print(f"‚ùå All agent types failed: {e}")
                print("\nüí° Check your configuration:")
                print("   ‚Ä¢ Azure OpenAI credentials in .env")
                print("   ‚Ä¢ Database connection settings")
                print("   ‚Ä¢ Required dependencies installed")
                return
    
    if not agent:
        print("‚ùå No agent could be initialized")
        return
    
    print(f"\nüéØ {agent_type} is ready!")
    print("\nüè• Healthcare Database Capabilities:")
    print("   ‚Ä¢ Patient demographics and medical records")
    print("   ‚Ä¢ Medical conditions and diagnoses")
    print("   ‚Ä¢ Medications and prescriptions")
    print("   ‚Ä¢ Medical procedures and treatments")
    print("   ‚Ä¢ Healthcare providers and organizations")
    
    print("\nüí¨ Example Questions:")
    print("   ‚Ä¢ 'How many patients do we have?'")
    print("   ‚Ä¢ 'Show me patients with diabetes'")
    print("   ‚Ä¢ 'What medications are prescribed for heart conditions?'")
    print("   ‚Ä¢ 'List recent emergency room visits'")
    
    print("\nüíæ JSON Saving Features:")
    if json_saver:
        print("   ‚úì Individual response files for each query")
        print("   ‚úì Session summary file at the end")
        print("   ‚úì Daily summary files")
        print("   ‚úì Searchable JSON format with metadata")
    else:
        print("   ‚ö†Ô∏è  JSON saving not available in this session")
    
    print("\n" + "-"*80)
    print("Type 'exit', 'help', 'save-session', or ask your question")
    print("-"*80)
    
    session_count = 0
    
    while True:
        try:
            user_input = input(f"\nüí¨ [{agent_type}] Ask about your data: ").strip()
            
            if user_input.lower() in ['exit', 'quit', 'q', 'bye']:
                if json_saver and session_responses:
                    session_file = json_saver.save_session_responses(session_responses, session_id)
                    if session_file:
                        print(f"üíæ Session summary saved to: {session_file}")
                
                print(f"\nüëã Thank you for using the {agent_type}!")
                print(f"üìä Session Summary: {len(session_responses)} queries processed")
                break
            
            if user_input.lower() in ['help', 'h']:
                print_help_with_json()
                continue
            
            if user_input.lower() == 'save-session':
                if json_saver and session_responses:
                    session_file = json_saver.save_session_responses(session_responses, session_id)
                    if session_file:
                        print(f"üíæ Session manually saved to: {session_file}")
                else:
                    print("‚ö†Ô∏è  No responses to save or JSON saver not available")
                continue
            
            if user_input.lower() == 'show-files':
                show_saved_files()
                continue
            
            if not user_input:
                print("üí≠ Please ask a question about your healthcare data!")
                continue
            
            session_count += 1
            print(f"\nüß† {agent_type} is processing your question...")
            
            try:
                start_time = datetime.now()
                
                if agent_type == "ReAct Agent":
                    response_obj = await agent.process_query(user_input)
                    if hasattr(response_obj, 'dict'):
                        response = {
                            "success": response_obj.success,
                            "answer": response_obj.message,
                            "query_understanding": response_obj.query_understanding,
                            "data": [r.data for r in response_obj.results] if response_obj.results else [],
                            "sql_generated": response_obj.sql_query,
                            "result_count": response_obj.result_count,
                            "metadata": response_obj.metadata,
                            "powered_by": response_obj.powered_by,
                            "structured_response": response_obj.dict()
                        }
                    else:
                        response = response_obj
                else:
                    if schema_description:
                        response = await agent.answer_question(user_input, f"session_{session_count}", schema_description)
                    else:
                        response = await agent.answer_question(user_input, f"session_{session_count}")
                
                processing_time = (datetime.now() - start_time).total_seconds()
                
                if "metadata" not in response:
                    response["metadata"] = {}
                response["metadata"]["processing_time_seconds"] = processing_time
                response["metadata"]["session_id"] = session_id
                response["metadata"]["query_number"] = session_count
                
                if json_saver:
                    saved_file = json_saver.save_response(response, user_input, session_id)
                    if saved_file:
                        print(f"üíæ Response saved to: {os.path.basename(saved_file)}")
                
                session_responses.append({
                    "query_metadata": {
                        "original_query": user_input,
                        "timestamp": start_time.isoformat(),
                        "session_id": session_id,
                        "query_number": session_count,
                        "processing_time_seconds": processing_time
                    },
                    "response": response
                })
                
                display_results_with_json_info(response, session_count, agent_type, saved_file if json_saver else None)
                
            except Exception as e:
                error_response = {
                    "success": False,
                    "answer": f"Error processing question: {str(e)}",
                    "query_understanding": user_input,
                    "data": None,
                    "sql_generated": None,
                    "metadata": {
                        "error_type": type(e).__name__,
                        "session_id": session_id,
                        "query_number": session_count
                    }
                }
                
                if json_saver:
                    saved_file = json_saver.save_response(error_response, user_input, session_id)
                    if saved_file:
                        print(f"üíæ Error response saved to: {os.path.basename(saved_file)}")
                
                session_responses.append({
                    "query_metadata": {
                        "original_query": user_input,
                        "timestamp": datetime.now().isoformat(),
                        "session_id": session_id,
                        "query_number": session_count,
                        "error": True
                    },
                    "response": error_response
                })
                
                print(f"\n‚ùå Error processing question: {str(e)}")
                print("üí° Try rephrasing your question or check your configuration")
                logger.error(f"Query processing error: {e}")
            
        except KeyboardInterrupt:
            print(f"\n\nüëã {agent_type} session ended!")
            break
        except Exception as e:
            print(f"\n‚ùå Unexpected error: {str(e)}")
            continue

def display_results_with_json_info(response: dict, session_count: int, agent_type: str, saved_file: str = None):
    
    print("\n" + "="*70)
    print(f"üìä SESSION {session_count} - {agent_type.upper()} RESULTS")
    print("="*70)
    
    status_icon = "‚úÖ" if response.get("success") else "‚ùå"
    status_text = "SUCCESS" if response.get("success") else "ERROR"
    print(f"\n{status_icon} STATUS: {status_text}")
    
    if saved_file:
        print(f"üíæ JSON SAVED: {os.path.basename(saved_file)}")
    
    if response.get("query_understanding"):
        print(f"üß† UNDERSTANDING: {response['query_understanding']}")
    
    if response.get("answer"):
        print(f"üí¨ ANSWER: {response['answer']}")
    
    if response.get("sql_generated"):
        print(f"\nüîß SQL QUERY:")
        print(f"   {response['sql_generated']}")
    
    data = response.get("data", [])
    if data and response.get("success"):
        result_count = len(data)
        print(f"\nüìä DATA RESULTS ({result_count} records):")
        print("-" * 50)
        
        for i, record in enumerate(data[:3], 1):
            print(f"\n   Record {i}:")
            if isinstance(record, dict):
                for key, value in record.items():
                    display_value = str(value)
                    if len(display_value) > 50:
                        display_value = display_value[:47] + "..."
                    print(f"      {key}: {display_value}")
            else:
                print(f"      {record}")
        
        if result_count > 3:
            print(f"\n   ... and {result_count - 3} more records")
    
    metadata = response.get("metadata", {})
    if metadata:
        print(f"\nüîç METADATA:")
        for key, value in metadata.items():
            if key in ["processing_time_seconds", "query_type", "tables_used"]:
                print(f"   {key}: {value}")
    
    if response.get("structured_response"):
        print(f"\nüìã STRUCTURED RESPONSE: Available in JSON file")
    
    print(f"\n‚ö° Powered by: {response.get('powered_by', agent_type)}")
    print("="*70)

def print_help_with_json():
    print("\n" + "="*60)
    print("üìñ HELP - HEALTHCARE DATABASE ASSISTANT WITH JSON SAVING")
    print("="*60)
    
    print("\nüí¨ HOW TO ASK QUESTIONS:")
    print("   ‚Ä¢ Use natural language - no need to know SQL!")
    print("   ‚Ä¢ Ask about patients, conditions, medications, procedures")
    print("   ‚Ä¢ Be specific about what you want to know")
    
    print("\nüè• HEALTHCARE DATA AVAILABLE:")
    print("   ‚Ä¢ PATIENTS: Demographics, personal information")
    print("   ‚Ä¢ CONDITIONS: Medical diagnoses and diseases")
    print("   ‚Ä¢ MEDICATIONS: Prescriptions and treatments")
    print("   ‚Ä¢ PROCEDURES: Medical procedures and surgeries")
    print("   ‚Ä¢ ENCOUNTERS: Doctor visits and hospital stays")
    print("   ‚Ä¢ PROVIDERS: Doctors and healthcare professionals")
    
    print("\nüíæ JSON SAVING FEATURES:")
    print("   ‚Ä¢ Each query response saved as individual JSON file")
    print("   ‚Ä¢ Session summary saved when you exit")
    print("   ‚Ä¢ Files saved in 'json_responses/' folder")
    print("   ‚Ä¢ Includes metadata: timestamps, processing time, session info")
    print("   ‚Ä¢ Searchable and machine-readable format")
    
    print("\n‚å®Ô∏è  COMMANDS:")
    print("   ‚Ä¢ 'help' - Show this help")
    print("   ‚Ä¢ 'save-session' - Manually save session summary")
    print("   ‚Ä¢ 'show-files' - Show saved JSON files")
    print("   ‚Ä¢ 'exit' or 'quit' - End session (auto-saves summary)")

def show_saved_files():
    json_dir = "json_responses"
    
    if not os.path.exists(json_dir):
        print("üìÅ No JSON files saved yet")
        return
    
    files = [f for f in os.listdir(json_dir) if f.endswith('.json')]
    
    if not files:
        print("üìÅ No JSON files found")
        return
    
    print(f"\nüìÅ SAVED JSON FILES ({len(files)} files):")
    print("-" * 50)
    
    files_with_time = [(f, os.path.getmtime(os.path.join(json_dir, f))) for f in files]
    files_with_time.sort(key=lambda x: x[1], reverse=True)
    
    for i, (filename, mtime) in enumerate(files_with_time[:10], 1):
        file_time = datetime.fromtimestamp(mtime).strftime("%Y-%m-%d %H:%M:%S")
        file_size = os.path.getsize(os.path.join(json_dir, filename))
        print(f"   {i:2d}. {filename}")
        print(f"       Created: {file_time} | Size: {file_size} bytes")
    
    if len(files) > 10:
        print(f"   ... and {len(files) - 10} more files")
    
    print(f"\nüìÇ Location: {os.path.abspath(json_dir)}")

if __name__ == "__main__":
    if len(sys.argv) > 1 and sys.argv[1] == "test":
        print("üß™ Testing connections...")
        asyncio.run(enhanced_database_cli_with_json())
    else:
        asyncio.run(enhanced_database_cli_with_json())